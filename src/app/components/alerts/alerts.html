<div class="service-card-container">
  @if (dataResource.isLoading()) {
  <div class="text-center text-secondary">Loading...</div>
  } @else if (dataResource.error()) {
  <div class="text-center text-error">Failed to load alert_service health.</div>
  } @else if (data()) {
  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div>
      <h2 class="text-xl font-semibold tracking-tight text-primary">
        {{ data()?.service }}
      </h2>
      <p class="text-sm text-secondary">Updated: {{ data()?.timestamp | date : 'medium' }}</p>
    </div>
    <span
      class="inline-flex items-center gap-2 text-sm font-medium px-3 py-1.5 rounded-full"
      [ngClass]="statusClasses()"
    >
      <span class="size-2 rounded-full" [ngClass]="dotClasses()"></span>
      {{ status() }}
    </span>
  </div>

  <!-- Grid -->
  <div class="grid md:grid-cols-3 gap-6 mt-6">
    <!-- Runtime -->
    <section class="col-span-1 space-y-3">
      <h3 class="text-sm font-semibold uppercase tracking-wider text-secondary">Runtime</h3>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div class="text-secondary">Node</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.nodeVersion }}</div>
        <div class="text-secondary">Platform</div>
        <div class="font-medium text-primary break-all text-xs">{{ data()?.runtime!.platform }}</div>
        <div class="text-secondary">Arch</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.arch }}</div>
        <div class="text-secondary">Env</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.environment }}</div>
        <div class="text-secondary">Domain</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.domainEnv }}</div>
        <div class="text-secondary">Uptime</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.uptime }}</div>
      </div>

      <!-- Memory -->
      <div class="flex items-center justify-between mt-4">
        <h4 class="text-sm font-semibold text-primary">Memory</h4>
        <span class="text-xs text-secondary">{{ memoryHealth()?.responseTime }} resp.</span>
      </div>

      <div class="mt-3 text-sm grid grid-cols-2 gap-2">
        <div class="text-secondary">RSS</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.memoryUsage.rss }}</div>
        <div class="text-secondary">Heap Used</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.memoryUsage.heapUsed }}</div>
        <div class="text-secondary">Heap Total</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.memoryUsage.heapTotal }}</div>
        <div class="text-secondary">External</div>
        <div class="font-medium text-primary">{{ data()?.runtime!.memoryUsage.external }}</div>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between text-xs">
          <span class="text-secondary">Heap Used %</span>
          <span class="font-medium text-primary">{{ (memoryHealth()?.details)!.heapUsedPercent }}%</span>
        </div>
        <div class="w-full h-2 bg-tertiary rounded-full mt-1 overflow-hidden">
          <div
            class="h-2 rounded-full transition-all"
            [ngClass]="barClasses()"
            [style.width.%]="(memoryHealth()?.details)!.heapUsedPercent"
          ></div>
        </div>
        <div class="mt-1 text-[11px] text-secondary">
          Threshold: {{ (memoryHealth()?.details)!.threshold }}%
        </div>

        @if (memoryHealth()?.status !== 'HEALTHY') {
        <div class="mt-3 text-xs text-warning">
          Memory status: {{ memoryHealth()?.status }}
        </div>
        }
      </div>
    </section>

    <!-- Versions -->
    <section class="col-span-2 border-l-4 pl-10 border-border">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold uppercase tracking-wider text-secondary">Versions</h3>
        <button
          type="button"
          class="text-xs px-3 py-1.5 rounded-lg border border-border hover:bg-secondary cursor-pointer text-primary"
          (click)="showJson.set(!showJson())"
        >
          {{ showJson() ? 'Hide' : 'Show' }} Raw JSON
        </button>
      </div>

      <div class="mt-3 grid grid-cols-1 gap-4">
        @for (v of versionEntries(); track v.key) {
        <div class="p-4 rounded-xl border border-border bg-secondary">
          <div class="flex items-center justify-between">
            <div class="font-medium text-primary">{{ v.key }}</div>
            @if (v.value.app) {
            <span class="text-xs text-secondary">app {{ v.value.app }}</span>
            }
          </div>
          <div class="mt-2 text-sm grid grid-cols-3 gap-x-2 gap-y-1">
            <div class="text-secondary">Commit</div>
            <div class="col-span-2 font-mono text-xs break-all text-primary">{{ short(v.value.commit) }}</div>

            <div class="text-secondary">Branch</div>
            <div class="col-span-2 font-medium text-primary">{{ v.value.branch }}</div>

            <div class="text-secondary">Tag</div>
            <div class="col-span-2 font-medium text-primary">{{ v.value.tag }}</div>

            @if (v.value.buildTime) {
            <div class="text-secondary">Build Time</div>
            <div class="col-span-2 font-medium text-primary">{{ v.value.buildTime | date : 'medium' }}</div>
            }
          </div>
        </div>
        }
      </div>

      @if (showJson()) {
      <pre
        class="mt-4 p-4 rounded-xl bg-tertiary border border-border overflow-auto text-xs text-primary"
      >
        {{ data() | json }}
          </pre
      >
      }
    </section>
  </div>
  }
</div>
